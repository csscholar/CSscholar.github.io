import*as d3 from"https://cdn.jsdelivr.net/npm/d3@7/+esm";import papaparse from"https://cdn.jsdelivr.net/npm/papaparse@5.4.1/+esm";import{Dataset,Filter}from"./dataset.min.js";const CITATION_COLUMN="citationCount",INITIAL_SORTED_COLUMN="hIndex",DISPLAY_COLUMNS=["hIndex","count",CITATION_COLUMN,"authors_selfCitations","authors_selfCitationsPercent","influentialCitationCount","coAuthors"],READABLE_COLUMN_NAME_MAP={Position:"Position",Name:"Name",citationCount:"Citations",influentialCitationCount:"Influential Citations",authors_selfCitations:"Self Citations",authors_selfCitationsPercent:"Median Self Citation %",coAuthors:"No. Co-Authors",count:"No. Papers",hIndex:"H-Index"},COLUMN_DESCRIPTIONS={hIndex:"At least h papers have at least h citations",count:"Total number of papers",citationCount:"Total number of citations (as reported by SemanticScholar)",authors_selfCitations:"Total number of self-citations (derived from SemanticScholar)",authors_selfCitationsPercent:"Median percentage of self-citations per-paper (derived from SemanticScholar)",influentialCitationCount:"Total number of influential citations (as reported by SemanticScholar https://www.semanticscholar.org/faq#influential-citations)",coAuthors:"Total number of unique Co-Authors"},COLUMN_AGG_FUNC={default:d3.sum,coAuthors:t=>t,authors_selfCitationsPercent:d3.median},COLUMN_RENDERER_MAP={authors_selfCitationsPercent:$.fn.dataTable.render.number(",",".",1,"")},IS_COLUMN_ORDERABLE={default:!0,Position:!1,Name:!1},INITIAL_VENUES=["SC","IPDPS","ISC","ICS","PPoPP","HPDC","CLUSTER","ICPP","EuroPar","CCGRID","HiPC"],INITIAL_AREAS=["HPC"],AREA_READABLE_NAME_MAP={HPC:"High Performance Computing",COMPBIO:"Computational Biology",ARCH:"Architecture",SE:"Software Engineering",VIS:"Visualization",PL:"Programming Languages",NLP:"Natural Language Processing",DB:"Databases",ML:"Machine Learning",CV:"Computer Vision",NET:"Networking and Communication",SEC:"Computer Security"};let dataset=null,datatable=null;function updateAuthorList(t=null){$("#load").show();var a,n,r,o=Array.from(DISPLAY_COLUMNS),t=dataset.getColumnsByAuthor(o,t),i=[];for([a,n]of Object.entries(t)){let t=0,e=0;CITATION_COLUMN in n&&(e=getHIndex(n[CITATION_COLUMN]));for(var[s,l]of Object.entries(n))Array.isArray(l)&&(t=l.length,r=s in COLUMN_AGG_FUNC?COLUMN_AGG_FUNC[s]:COLUMN_AGG_FUNC.default,n[s]=r(l));n.count=t,n.hIndex=e;var c=[0,a];for(const d of o)c.push(n[d]);i.push(c)}t=["Position","Name"].concat(o);datatable?(datatable.clear(),datatable.rows.add(i),datatable.draw()):(datatable=$("#list-view__table").DataTable({data:i,columns:t.map(t=>getDataTableColumnSpec(t)),order:[[t.indexOf(INITIAL_SORTED_COLUMN),"desc"]],pageLength:25,rowCallback:function(t,e,a){var n=$(this).DataTable(),r=n.page.info();return"desc"===n.order()[0][1]?$("td:nth-child(1)",t).html(String(r.start+a+1)):$("td:nth-child(1)",t).html(String(r.recordsTotal-r.start-a)),t},drawCallback:function(){$("#load").hide()}}),addTooltipsToTableHeader())}function addTooltipsToTableHeader(){$("#list-view__table thead th").each(function(t){t=DISPLAY_COLUMNS[t-2];$(this).attr("title",COLUMN_DESCRIPTIONS[t])})}function getDataTableColumnSpec(t){var e={title:READABLE_COLUMN_NAME_MAP[t]};return t in COLUMN_RENDERER_MAP&&(e.render=COLUMN_RENDERER_MAP[t]),e.orderable=t in IS_COLUMN_ORDERABLE?IS_COLUMN_ORDERABLE[t]:IS_COLUMN_ORDERABLE.default,e}function getHIndex(e){e.sort(function(t,e){return e-t});let a=0;for(let t=0;t<e.length&&e[t]>=t+1;t++)a=t+1;return a}function initializeYearsFilterUI(t){t.sort();var e=$("#years-filter-start"),a=$("#years-filter-end");for(const r of t)e.append($("<option>").val(r).text(r)),a.append($("<option>").val(r).text(r));var n=+t[t.length-1];t.includes(n-10)?e.val(n-10):e.find("option:first").prop("selected",!0),a.find("option:last").prop("selected",!0),e.on("change",updateYears),a.on("change",updateYears)}function initializeVenuesFilterUI(t){var e,a=Object.keys(t).sort(),n=$("#venues-form");for(e of a){var r,o="venues-form-"+e,i=e in AREA_READABLE_NAME_MAP?AREA_READABLE_NAME_MAP[e]:e,s=$("<div>"),i=$("<a>").addClass("area-dropdown").attr("id","areas-dropdown__"+e).attr("data-bs-toggle","collapse").attr("href","#"+o).attr("role","button").attr("aria-expanded","false").attr("aria-controls",o).html('<i class="fa fa-circle-chevron-right"></i> '+i),l=$("<input>").addClass("settings-checkbox form-check-inline area-checkbox").attr("type","checkbox").attr("id","areas__"+e).attr("value",e).prop("checked",INITIAL_AREAS.includes(e)),c=$("<div>").addClass("venue-list form-grid collapse").attr("id",o);for(r of Array.from(t[e]).sort()){var d=$("<div>").addClass("form-check").append($("<input>").addClass("settings-checkbox form-check-input venue-checkbox").attr("type","checkbox").attr("id","venues__"+r).attr("name","venue").attr("value",r).prop("checked",INITIAL_VENUES.includes(r))).append($("<label>").attr("for","venues__"+r).addClass("form-check-label").text(r));c.append(d)}s.append(i,l,c),n.append(s)}$("#venues-form .venue-checkbox").on("change",function(){updateAuthorList(getFilter())}),$("#venues-form .area-checkbox").on("change",function(){updateSelectedAreas(this)}),$(".area-dropdown").on("click",function(){rotateCaret(this)})}function updateSelectedAreas(t){var e=$(t).parent().find(".venue-checkbox");let a=$(t).prop("checked");$(e).each(function(){$(this).prop("checked",a)}),updateAuthorList(getFilter())}function rotateCaret(t){$(t).find("i").toggleClass("fa-circle-chevron-right fa-circle-chevron-down")}function getAllSelectValues(t){let e=[];return $(t+" option").each(function(){e.push($(this).val())}),e}function getFilter(){const e=+$("#years-filter-start").find(":selected").val(),a=+$("#years-filter-end").find(":selected").val();var t=getAllSelectValues("#years-filter-start").map(t=>+t).filter(t=>t>=e&&t<=a);let n=[];return $("#venues-form input[type='checkbox']:checked").each(function(){n.push($(this).val())}),new Filter(t,n)}function updateYears(){const e=+$("#years-filter-start").find(":selected").val(),a=+$("#years-filter-end").find(":selected").val();e>a?(console.log(`Start year (${e}) cannot be later than end year (${a}).`),$("#years-filter-start").val(a).change()):($("#years-filter-start option").each(function(){var t=$(this);t.prop("disabled",+t.val()>a)}),$("#years-filter-end option").each(function(){var t=$(this);t.prop("disabled",+t.val()<e)}),updateAuthorList(getFilter()))}$(function(){$("#load").show(),papaparse.parse("/data/site-data.csv",{download:!0,delimiter:",",header:!0,fastMode:!0,dynamicTyping:!0,complete:t=>{var t=(dataset=new Dataset(t.data)).getUnique("year"),e=dataset.getVenuesByArea();initializeYearsFilterUI(t),initializeVenuesFilterUI(e),updateAuthorList(getFilter())}})});